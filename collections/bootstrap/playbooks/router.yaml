# bootstrap/playbooks/router.yaml
---
- name: Top-level router
  hosts: router
  variables:
    # TODO: Ensure DHCP settings for WAN interface

    # TODO: Configure DNSCrypt on WAN
    - name: Install DNSCrypt-Proxy plugin
      oxlorg.opnsense.package:
        name: os-dnscrypt-proxy
        action: 'install'

    # TODO: Enaable Unbound with DNSSEC and hardening on LAN

    # TODO: Enable Kea DHCP, disable ISC and Unbound DNS

    # TODO: Firewall: block LAN -> WAN:53

    - name: Setup DHCP range for LAN
      oxlorg.opnsense.dhcp_general:
        enabled: true
        socket_type: raw
        interfaces: lan
        fw_rules: true
        lifetime: 4000

    - name: Setup DHCP subnets
      oxlorg.opnsense.dhcp_subnet:
        subnet: "{{ subnet.cidr }}"
        pools:
          - "{{ subnet.pool }}"
        auto_options: false
        gateway: "{{ subnet.gateway }}"
        dns: ['127.0.0.1']
        domain: "{{ subnet.domain }}"
      loop: dhcp_subnet_list
      loop_control:
        var: subnet

    - name: Setup static DHCP mappings for defined clients
      oxlorg.opnsense.dhcp_reservation:
        ip: "{{ host.ip }}"
        subnet: "{{ host.subnet }}"
        mac: "{{ host.mac }}"
      loop: dhcp_static_ip_list
      loop_control:
        var: host

    # TODO: Setup LAN gateway

    # TODO: Firewall: Setup NAT LAN GW -> Outbound
